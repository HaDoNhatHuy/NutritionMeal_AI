@using System.Text.Json
@using NutritionWebApp.Models.Entities
@using System.Collections.Generic
@{
    ViewData["Title"] = "Theo dõi Uống nước";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .water-tracker-wrapper {
            min-height: 100vh;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            padding: 40px 0;
        }

        .tracker-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            color: #0c4a6e;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #0369a1;
            font-size: 1.1rem;
        }

        .main-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .water-goal-section {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 20px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

            .water-goal-section::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -20%;
                width: 300px;
                height: 300px;
                background: rgba(255,255,255,0.1);
                border-radius: 50%;
            }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .goal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .edit-goal-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .edit-goal-btn:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-2px);
            }

        .progress-container {
            position: relative;
            z-index: 1;
        }

        .progress-bar-custom {
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22d3ee 0%, #06b6d4 100%);
            border-radius: 20px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .progress-text {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
        }

        .quick-add-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-add-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .quick-add-btn {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .quick-add-btn:hover {
                background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
            }

        .quick-add-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .quick-add-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0c4a6e;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-chart {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }

        .today-logs {
            margin-top: 20px;
        }

        .log-item {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

            .log-item:hover {
                transform: translateX(5px);
                box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
            }

        .log-time {
            font-weight: 600;
            color: #0369a1;
        }

        .log-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0c4a6e;
        }

        @@media (max-width: 768px) {
            .main-card {
                padding: 25px;
            }

            .quick-add-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
}

<div class="water-tracker-wrapper">
    <div class="container tracker-container">
        <div class="page-header">
            <h1 class="page-title">💧 Theo dõi Uống nước</h1>
            <p class="page-subtitle">Duy trì đủ nước cho cơ thể khỏe mạnh</p>
        </div>

        <div class="main-card">
            <!-- Goal Section -->
            <div class="water-goal-section">
                <div class="goal-header">
                    <h3 class="goal-title">🎯 Mục tiêu hôm nay</h3>
                    <button class="edit-goal-btn" onclick="editGoal()">✏️ Chỉnh sửa</button>
                </div>

                <div class="progress-container">
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">
                            <span id="progressPercentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-text">
                        <span id="currentAmount">0</span> / <span id="goalAmount">@ViewBag.TodayIntake.GoalMl</span> ml
                    </div>
                </div>
            </div>

            <!-- Quick Add Section -->
            <div class="quick-add-section">
                <h4 class="section-title">⚡ Thêm nhanh</h4>
                <div class="quick-add-buttons">
                    <div class="quick-add-btn" onclick="addWater(100,event)">
                        <span class="quick-add-icon">💧</span>
                        <div class="quick-add-amount">100ml</div>
                    </div>
                    <div class="quick-add-btn" onclick="addWater(250m,event)">
                        <span class="quick-add-icon">🥤</span>
                        <div class="quick-add-amount">250ml</div>
                    </div>
                    <div class="quick-add-btn" onclick="addWater(500,event)">
                        <span class="quick-add-icon">🍶</span>
                        <div class="quick-add-amount">500ml</div>
                    </div>
                    <div class="quick-add-btn" onclick="addWater(750,event)">
                        <span class="quick-add-icon">🧃</span>
                        <div class="quick-add-amount">750ml</div>
                    </div>
                </div>
            </div>

            <!-- Today's Logs -->
            <div class="today-logs">
                <h4 class="section-title">📝 Lịch sử hôm nay</h4>
                <div id="logsContainer">
                    @if (ViewBag.TodayIntake.WaterLogs.Count == 0)
                    {
                        <p style="text-align: center; color: #64748b; padding: 20px;">Chưa có dữ liệu. Hãy bắt đầu uống nước! 💪</p>
                    }
                    else
                    {
                        @foreach (var log in ((IEnumerable<WaterLog>)ViewBag.TodayIntake.WaterLogs).OrderByDescending(l => l.LoggedAt))
                        {
                            <div class="log-item">
                                <span class="log-time">⏰ @log.LoggedAt.ToString("HH:mm")</span>
                                <span class="log-amount">@log.AmountMl ml</span>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- History Chart -->
            <div class="history-section">
                <h4 class="section-title">📊 Thống kê 7 ngày</h4>
                <div class="history-chart">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        let currentTotal = @ViewBag.TodayIntake.TotalMl;
        let goalAmount = @ViewBag.TodayIntake.GoalMl;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            renderWeeklyChart();
        });

        function updateProgress() {
            const percentage = Math.min((currentTotal / goalAmount) * 100, 100);
            const progressFill = document.getElementById('progressFill');

            // ✅ CẢI TIẾN: Smooth animation
            progressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            progressFill.style.width = percentage + '%';

            // ✅ THÊM: Đổi màu theo tiến độ
            if (percentage >= 100) {
                progressFill.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
            } else if (percentage >= 75) {
                progressFill.style.background = 'linear-gradient(90deg, #22d3ee 0%, #06b6d4 100%)';
            } else if (percentage >= 50) {
                progressFill.style.background = 'linear-gradient(90deg, #3b82f6 0%, #2563eb 100%)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
            }

            document.getElementById('progressPercentage').textContent = percentage.toFixed(0) + '%';
            document.getElementById('currentAmount').textContent = currentTotal;
            document.getElementById('goalAmount').textContent = goalAmount;
        }

        async function addWater(amount,event) {
            try {
                const response = await fetch('/WaterTracker/AddWater', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amountMl: amount })
                });

                const data = await response.json();

                if (data.success) {
                    currentTotal = data.totalMl;
                    updateProgress();

                    // ✅ THÊM: Animation khi thêm nước
                    const addedBtn = event.target.closest('.quick-add-btn');
                    addedBtn.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        addedBtn.style.transform = 'scale(1)';
                    }, 200);

                    // Add log to UI
                    const now = new Date();
                    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                    const logHtml = `
                    <div class="log-item" style="animation: slideIn 0.5s ease;">
                        <span class="log-time">⏰ ${timeStr}</span>
                        <span class="log-amount">${amount} ml</span>
                    </div>`;

                    document.getElementById('logsContainer').insertAdjacentHTML('afterbegin', logHtml);

                    // ✅ THÊM: Confetti khi đạt mục tiêu
                    // if (data.progress >= 100) {
                    //     confetti({
                    //         particleCount: 100,
                    //         spread: 70,
                    //         origin: { y: 0.6 },
                    //         colors: ['#22d3ee', '#06b6d4', '#0ea5e9']
                    //     });

                    //     setTimeout(() => {
                    //         alert('🎉 Chúc mừng! Bạn đã hoàn thành mục tiêu uống nước hôm nay!');
                    //     }, 500);
                    // }
                            // Thêm vào cuối hàm addWater()
                        if (data.progress >= 100) {
                            // Confetti effect
                            const duration = 3 * 1000;
                            const end = Date.now() + duration;

                            (function frame() {
                                confetti({
                                    particleCount: 3,
                                    angle: 60,
                                    spread: 55,
                                    origin: { x: 0 }
                                });
                                confetti({
                                    particleCount: 3,
                                    angle: 120,
                                    spread: 55,
                                    origin: { x: 1 }
                                });

                                if (Date.now() < end) {
                                    requestAnimationFrame(frame);
                                }
                            }());

                            // Achievement modal
                            showAchievementModal('💧 Hoàn thành mục tiêu!', 'Bạn đã uống đủ nước hôm nay!');
                        }
                } else {
                    alert('❌ Lỗi: ' + data.error);
                }
            } catch (error) {
                alert('❌ Lỗi kết nối: ' + error.message);
            }
        }

        // ✅ THÊM: Animation cho logs
        const style = document.createElement('style');
        style.textContent = `
        @@keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(style);

        async function editGoal() {
            const newGoal = prompt('Nhập mục tiêu mới (ml):', goalAmount);
            if (newGoal && !isNaN(newGoal) && newGoal > 0) {
                try {
                    const response = await fetch('/WaterTracker/SetGoal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ goalMl: parseInt(newGoal) })
                    });

                    const data = await response.json();
                    if (data.success) {
                        goalAmount = parseInt(newGoal);
                        updateProgress();
                        alert('✅ Đã cập nhật mục tiêu!');
                    }
                } catch (error) {
                    alert('Lỗi: ' + error.message);
                }
            }
        }

        function renderWeeklyChart() {
            @{
                var jsonOptions = new System.Text.Json.JsonSerializerOptions
                    {
                        ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles
                    };
            }
            const history = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.History, jsonOptions));

            const dates = history.map(h => new Date(h.IntakeDate).toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit', month: '2-digit' }));
            const totals = history.map(h => h.TotalMl);
            const goals = history.map(h => h.GoalMl);

            new Chart(document.getElementById('weeklyChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Đã uống',
                        data: totals,
                        backgroundColor: 'rgba(14, 165, 233, 0.8)',
                        borderColor: 'rgba(14, 165, 233, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }, {
                        label: 'Mục tiêu',
                        data: goals,
                        type: 'line',
                        borderColor: 'rgba(251, 146, 60, 1)',
                        borderWidth: 3,
                        borderDash: [5, 5],
                        pointRadius: 5,
                        pointBackgroundColor: 'rgba(251, 146, 60, 1)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' ml';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ml';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
}