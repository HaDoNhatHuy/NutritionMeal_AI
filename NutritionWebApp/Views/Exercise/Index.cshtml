@model List<NutritionWebApp.Models.Entities.ExerciseVideo>
@{
    ViewData["Title"] = "Bài tập";
    var groups = new[] { "Đùi", "Lưng", "Ngực", "Bụng", "Vai", "Tay trước", "Tay sau" };
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Lấy nhóm cơ đang được chọn từ Controller [4]
    string currentGroup = ViewBag.Group as string ?? "";
}
@section Styles {
    <style>
        /* =================================================== */
        /* I. STYLES CÓ SẴN TỪ SOURCE [1-3] */
        /* =================================================== */
        .exercise-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 60px 0;
            margin-bottom: 40px;
            border-radius: 0 0 50px 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

            .exercise-header h1 {
                color: white;
                font-weight: 700;
                font-size: 2.5rem;
                margin: 0;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            }

        /* Ẩn filter pills cũ để thay bằng Group Card */
        .filter-pills {
            display: none;
        }

        .video-card {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            height: 100%;
            background: white;
        }

            .video-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            }

        .video-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 20px 20px 0 0;
        }

            .video-wrapper::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.3));
                pointer-events: none;
            }

            .video-wrapper iframe {
                border: none;
            }

        .video-card .card-body {
            padding: 25px;
            background: white;
        }

        .video-card h5 {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .video-duration {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
            background: #f7fafc;
            padding: 8px 16px;
            border-radius: 12px;
        }

            .video-duration::before {
                content: '⏱️';
                font-size: 1.1rem;
            }

        .videos-grid {
            display: grid;
            /* Lưới đáp ứng, tối thiểu 350px mỗi cột */
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            padding: 0 15px;
        }

        /* =================================================== */
        /* II. NEW STYLES: GROUP CARDS (THẺ CHỌN NHÓM CƠ) */
        /* =================================================== */
        .muscle-group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px auto 50px auto;
        }

        .group-card {
            text-align: center;
            border-radius: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            height: 100%;
            text-decoration: none;
            display: block;
            background: white;
            border: 2px solid transparent;
        }

            .group-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            }

            .group-card.active { /* Highlight khi được chọn */
                border-color: #667eea;
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            }

        .group-card-body {
            padding: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
        }

        .group-card-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: block;
        }

        /* Thẻ đề xuất AI */
        #aiRecommendationCard {
            border-left: 6px solid #48bb78; /* Xanh lá [5] */
            background-color: #f7fffb;
            animation: fadeIn 0.5s ease;
        }
    </style>
}

<div class="exercise-header">
    <div class="container">
        <h1 class="text-center">💪 Bài tập theo nhóm cơ</h1>
    </div>
</div>

<div class="container">

    <!-- KHỐI 1: ĐỀ XUẤT CÁ NHÂN HÓA AI (BẠN SẼ CẦN THÊM JS ĐỂ GỌI VÀ HIỂN THỊ) -->
    <div id="aiRecommendationCard" class="card shadow p-4 mb-5" style="display: block;">
        <h4 class="card-title" style="color: #48bb78;">
            <span id="aiRecTitle">✨ Đang phân tích đề xuất cá nhân...</span>
        </h4>
        <div id="aiRecContent">
            Đang phân tích Calo nạp vào hôm nay so với TDEE mục tiêu của bạn.
        </div>
        <div class="mt-3">
            <a id="goToSuggestedGroupBtn" href="#" class="btn btn-sm" style="background: #667eea; color: white; display: none;">
                Xem bài tập nhóm cơ <span id="suggestedGroupText"></span>
            </a>
        </div>
    </div>

    <h3 class="text-center mb-4" style="font-weight: 700; color: #2d3748;">Chọn Nhóm Cơ Bạn Muốn Tập</h3>

    <!-- KHỐI 2: CHỌN NHÓM CƠ (NAVIGATION/FILTER) -->
    <div class="muscle-group-grid">

        <!-- Thẻ: Tất cả -->
        <a asp-action="Index" class="group-card @(string.IsNullOrEmpty(currentGroup) ? "active" : "")">
            <div class="group-card-body">
                <span class="group-card-icon">⭐</span>
                Tất cả Bài tập
            </div>
        </a>

        <!-- Các Thẻ Nhóm cơ -->
        @foreach (var g in groups)
        {
            <a asp-action="Index" asp-route-group="@g" class="group-card @(currentGroup == g ? "active" : "")">
                <div class="group-card-body">
                    <span class="group-card-icon">@((g == "Bụng" ? "🧘" : g == "Ngực" ? "💪" : g == "Đùi" ? "🦵" : "🎯"))</span>
                    @g
                </div>
            </a>
        }
    </div>

    <!-- KHỐI 3: HIỂN THỊ VIDEO DẠNG GRID -->
    @if (Model == null || !Model.Any())
    {
        <p class="alert alert-info text-center" style="margin-top: 50px;">
            Không tìm thấy video nào thuộc nhóm cơ **@(string.IsNullOrEmpty(currentGroup) ? "Tất cả" : currentGroup)** trong kho dữ liệu.
        </p>
    }

    <div class="videos-grid">
        @foreach (var v in Model)
        {
            <div class="video-card">
                <div class="video-wrapper">
                    <div class="ratio ratio-16x9">
                        <!-- Nhúng Video YouTube (Sử dụng URL từ Model [6]) -->
                        <!-- Thêm tham số tối ưu iframe (nếu cần): ?controls=1&showinfo=0&rel=0 -->
                        <iframe src="@v.YoutubeVideoUrl"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                        </iframe>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Title và Duration được lấy tự động từ YouTube API -->
                    <h5>@v.Title</h5>
                    <span class="video-duration">@v.Duration</span>
                    <span class="badge" style="background-color: #eef2ff; color: #667eea; font-weight: 600; margin-left: 10px;">@v.MuscleGroup</span>
                </div>
            </div>
        }
    </div>
</div>
@section Scripts {
    <script>
        // *** LOGIC TẢI ĐỀ XUẤT AI (Dựa trên hướng dẫn trước) ***
        document.addEventListener('DOMContentLoaded', function() {
            getExerciseAdvice();
        });

        async function getExerciseAdvice() {
            const card = document.getElementById('aiRecommendationCard');
            const contentDiv = document.getElementById('aiRecContent');
            const titleDiv = document.getElementById('aiRecTitle');
            const goToBtn = document.getElementById('goToSuggestedGroupBtn');
            const suggestedGroupText = document.getElementById('suggestedGroupText');

            contentDiv.innerHTML = `<div class="spinner-border spinner-border-sm text-success" role="status"></div> Đang phân tích dữ liệu dinh dưỡng...`;

            try {
                // Gọi API ASP.NET Core
                const response = await fetch('/Exercise/GetPersonalizedAdvice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                if (data.error) {
                    contentDiv.innerHTML = `Lỗi phân tích AI: ${data.error}`;
                    card.style.borderLeftColor = '#f56565';
                    return;
                }

                // Hiển thị kết quả
                contentDiv.innerHTML = `<p>${data.advice_summary}</p>`;
                titleDiv.innerHTML = `✨ Đề xuất Bài tập: ${data.suggestion_type}`;

                const group = data.muscle_group_focus;
                if (group) {
                    suggestedGroupText.textContent = group;
                    goToBtn.style.display = 'inline-block';

                    // Chuyển hướng đến nhóm cơ được đề xuất
                    goToBtn.onclick = function() {
                        window.location.href = `/Exercise?group=${group}`;
                    };
                }

            } catch (error) {
                contentDiv.innerHTML = `Lỗi kết nối dịch vụ AI.`;
                card.style.borderLeftColor = '#f56565';
            }
        }
    </script>
}