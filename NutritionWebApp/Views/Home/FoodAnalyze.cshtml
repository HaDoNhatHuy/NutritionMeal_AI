@{
    ViewData["Title"] = "Phân tích món ăn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <style>
        .analyze-section {
            min-height: 100vh;
            /* background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #f0f4f8 100%); */
            padding: 60px 0;
        }

        .analyze-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .page-title {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .upload-area {
            border: 3px dashed #48bb78;
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f0fdf4 0%, #f8fafc 100%);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

            .upload-area:hover {
                border-color: #38a169;
                background: linear-gradient(135deg, #e6f9f0 0%, #f1f5f9 100%);
                transform: scale(1.02);
            }

            .upload-area.active {
                border-color: #48bb78;
                background: linear-gradient(135deg, #f0fff4 0%, #f0fdf4 100%);
            }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #718096;
            font-size: 0.95rem;
        }

        .file-input {
            display: none;
        }

        .preview-image-inside {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 18px;
            display: none;
        }

        .upload-area.has-preview #uploadPrompt {
            display: none;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 15px;
            padding: 15px 50px;
            /* font-size: 1.2rem; */
            font-weight: 700;
            color: white;
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
            transition: all 0.3s ease;
            margin-top: 20px;
            display: none;
        }

            .analyze-btn:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
            }

            .analyze-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        /* Loading Animation */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

            .loading-overlay.show {
                display: flex;
            }

        .loading-content {
            text-align: center;
            color: #2d3748;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

            .spinner-ring:nth-child(2) {
                border-top-color: #4299e1;
                animation-duration: 1.5s;
            }

            .spinner-ring:nth-child(3) {
                border-top-color: #ed8936;
                animation-duration: 2s;
            }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .loading-subtext {
            font-size: 1rem;
            opacity: 0.8;
            animation: pulse 2s ease-in-out infinite;
            color: #4a5568;
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* Result Card */
        .result-card {
            background: white;
            border-radius: 25px;
            padding: 35px;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease;
            border-left: 6px solid #48bb78;
        }

            .result-card.success {
                border-left-color: #48bb78;
            }

                .result-card.success .food-name {
                    color: #48bb78;
                }

                .result-card.success .nutrition-item {
                    background: linear-gradient(135deg, #f0fff4 0%, #f0fdf4 100%);
                    border: 1px solid #d1fae5;
                }

                .result-card.success .nutrition-value {
                    color: #059669;
                }

            .result-card.warning {
                border-left-color: #f56565;
            }

        @@keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .food-name {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .nutrition-item {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .nutrition-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .nutrition-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #fc8181;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .warning-text {
            color: #c53030;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @@media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .upload-card {
                padding: 25px;
            }

            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }        
        @@media (max-width: 576px) {
            .upload-area

        {
            min-height: 250px; /* Thay vì 300px */
            padding: 30px 20px;
        }

        #mealTypeSelect {
            font-size: 1.1rem;
            padding: 16px 20px;
            border: 3px solid #10b981; /* Làm nổi bật hơn */
        }

        .preview-image-inside {
            object-fit: contain; /* Thay vì cover để xem full ảnh */
        }

        }
    </style>
    <style>
        /* --- THÊM VÀO CUỐI PHẦN STYLE --- */

        /* Style cho nút Pro */
        .analyze-btn.btn-pro {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #d4af37 100%); /* Màu vàng Gold */
            color: #5c3a00; /* Chữ màu nâu đậm cho dễ đọc trên nền vàng */
            position: relative;
            overflow: visible; /* Để hiển thị tag PRO bay ra ngoài */
            border: 1px solid #ecc94b;
        }

            .analyze-btn.btn-pro:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 35px rgba(214, 158, 46, 0.5); /* Bóng màu vàng */
            }

        /* Tag PRO nhỏ gắn trên nút */
        .pro-badge {
            position: absolute;
            top: -12px;
            right: -10px;
            background: #e53e3e; /* Màu đỏ */
            color: white;
            font-size: 0.75rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: bounce 2s infinite;
        }

        @@keyframes bounce {
            0%, 100%

        {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-3px);
        }

        }

        /* --- CUSTOM MODAL NÂNG CẤP PRO --- */
        .pro-modal-overlay {
            display: none; /* Mặc định ẩn */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

            .pro-modal-overlay.show {
                display: flex;
                opacity: 1;
            }

        .pro-modal-card {
            background: white;
            width: 90%;
            max-width: 450px;
            border-radius: 25px;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-top: 8px solid #FDB931;
        }

        .pro-modal-overlay.show .pro-modal-card {
            transform: scale(1);
        }

        .pro-icon-large {
            font-size: 4rem;
            margin-bottom: 20px;
            display: inline-block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .pro-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 10px;
            background: -webkit-linear-gradient(#FDB931, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .pro-desc {
            color: #718096;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .btn-upgrade {
            background: linear-gradient(135deg, #FDB931 0%, #d4af37 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.4);
            transition: all 0.3s ease;
        }

            .btn-upgrade:hover {
                transform: scale(1.05);
                box-shadow: 0 15px 30px rgba(212, 175, 55, 0.5);
            }

        .btn-close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #a0aec0;
            cursor: pointer;
        }

            .btn-close-modal:hover {
                color: #4a5568;
            }
    </style>
}
<div class="analyze-section">
    <div class="container analyze-container">
        <h1 class="page-title">📸 Phân tích món ăn của bạn</h1>

        <div class="upload-card">
            <!-- KHỐI BỔ SUNG: CHỌN LOẠI BỮA ĂN -->
            <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 20px;">1. Chọn Loại Bữa Ăn</h4>
            <select id="mealTypeSelect" class="form-select mb-4" style="
                    border: 2px solid #e2e8f0;
                    border-radius: 15px;
                    padding: 14px 20px;
                    font-size: 1rem;
                    transition: all 0.3s ease;">
                <option value="ChuaChon">--- Chọn loại bữa ăn ---</option>
                <option value="BuaSang">☀️ Bữa Sáng</option>
                <option value="BuaTrua">🍔 Bữa Trưa</option>
                <option value="BuaToi">🌙 Bữa Tối</option>
                <option value="AnVat">🍭 Ăn Vặt / Khác</option>
            </select>
            <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 20px;">2. Tải ảnh món ăn</h4>

            <div class="upload-area" id="uploadAreaContainer" onclick="document.getElementById('foodImage').click()">
                <div id="uploadPrompt">
                    <span class="upload-icon">📷</span>
                    <div class="upload-text">Nhấn để chọn ảnh hoặc chụp ảnh</div>
                    <div class="upload-hint">Hỗ trợ: JPG, PNG (tối đa 10MB)</div>
                </div>
                <!-- ẢNH PREVIEW (SẼ HIỂN THỊ TRONG KHUNG) -->
                <img id="preview" class="preview-image-inside" alt="Preview" />
            </div>

            @* <input type="file" id="foodImage" accept="image/*" capture="environment" class="file-input" /> *@
            @* <input type="file" id="foodImage" accept="image/*" capture="user" class="file-input" /> *@
            <input type="file" id="foodImage" accept="image/*" class="file-input" />

            @* ✅ THÊM: Tips Section *@
            <div id="analysisTips" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 4px solid #f59e0b;">
                <h5 style="color: #92400e; font-weight: 700; margin-bottom: 10px;">💡 Mẹo để AI phân tích chính xác:</h5>
                <ul style="color: #78350f; margin: 0; padding-left: 20px; font-size: 0.9rem;">
                    <li>Chụp ảnh rõ nét, đủ ánh sáng</li>
                    <li>Hiển thị toàn bộ món ăn trong khung hình</li>
                    <li>Tránh che khuất bởi tay hoặc vật dụng</li>
                    <li>Một ảnh nên chỉ có một món ăn chính</li>
                </ul>
            </div>

            @* <div class="text-center">                
                <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">
                    🔍 Phân tích ngay
                </button>
            </div> *@
            @* <div class="text-center d-flex justify-content-center gap-3 mt-4">
                <button class="analyze-btn btn-success" id="analyzeSimpleBtn" onclick="analyze(false)">
                    Phân tích (Calories)
                </button>
                <button class="analyze-btn btn-primary" id="analyzeDeepBtn" onclick="analyze(true)"
                        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    Phân tích Chuyên sâu
                </button>
            </div> *@
            <div class="text-center d-flex justify-content-center gap-3 mt-4 flex-wrap">
                <button class="analyze-btn btn-success" id="analyzeSimpleBtn" onclick="analyze(false)">
                    🔍 Phân tích Cơ bản
                </button>

                <button class="analyze-btn btn-pro" id="analyzeDeepBtn" onclick="showUpgradeModal()">
                    <span class="pro-badge">PRO</span>
                    🔒 Phân tích Chuyên sâu
                </button>
            </div>
        </div>

        <div id="result"></div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <div class="loading-text">🤖 AI đang phân tích...</div>
        <div class="loading-subtext" id="loadingSubtext">Vui lòng chờ trong giây lát</div>
    </div>
</div>

<!-- NÂNG CẤP PRO MODAL -->
<div class="pro-modal-overlay" id="upgradeModal" onclick="closeUpgradeModal(event)">
    <div class="pro-modal-card">
        <button class="btn-close-modal" onclick="document.getElementById('upgradeModal').classList.remove('show')">&times;</button>

        <div class="pro-icon-large">👑</div>
        <h2 class="pro-title">Mở khóa Phân tích Chuyên sâu</h2>
        <p class="pro-desc">
            Tính năng này cung cấp chi tiết <strong>Vitamin, Khoáng chất, Cảnh báo dị ứng</strong> và <strong>Lộ trình đốt calo</strong> cá nhân hóa.
        </p>

        <ul style="text-align: left; margin-bottom: 25px; color: #4a5568; list-style: none; padding-left: 10px;">
            <li style="margin-bottom: 8px;">✅ Phân tích thành phần vi lượng</li>
            <li style="margin-bottom: 8px;">✅ Phát hiện chất gây dị ứng</li>
            <li style="margin-bottom: 8px;">✅ Gợi ý bài tập đốt calo chính xác</li>
        </ul>

        <button class="btn-upgrade" onclick="goToPayment()">
            Nâng cấp ngay - Chỉ 49k/tháng
        </button>

        <p style="margin-top: 15px; font-size: 0.85rem; color: #a0aec0; cursor: pointer;">
            <u>Khôi phục giao dịch mua</u>
        </p>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('foodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    const uploadArea = document.querySelector('.upload-area');
                    const analyzeBtn = document.getElementById('analyzeBtn');
                    const uploadPrompt = document.getElementById('uploadPrompt');
                    const analysisTips = document.getElementById('analysisTips');

                    preview.src = e.target.result;
                    preview.className = 'preview-image-inside';
                    preview.style.display = 'block';
                    uploadPrompt.style.display = 'none';
                    uploadArea.classList.add('active');
                    uploadArea.classList.add('has-preview');
                    // analyzeBtn.style.display = 'inline-block';

                    // ✅ HIỂN THỊ TIPS
                    analysisTips.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
    <script>
        // Khai báo biến toàn cục để kiểm soát interval (Chức năng 6b)
        let loadingTextInterval;
        const loadingMessages = [
            "AI đang nhận diện món ăn...",
            "Đang tính toán giá trị dinh dưỡng...",
            "Đang cá nhân hóa lời khuyên dựa trên mục tiêu...",
            "Gần xong rồi, chỉ vài giây nữa thôi!"
        ];

        // Hàm Khởi tạo hiệu ứng Loading Text (Chức năng 6b)
        function startLoadingAnimation() {
            const subtextElement = document.getElementById('loadingSubtext');
            let index = 0;

            // Đặt nội dung ban đầu
            subtextElement.textContent = loadingMessages[index];
            index = (index + 1) % loadingMessages.length;

            // Thiết lập interval để thay đổi nội dung mỗi 2000ms (2 giây)
            loadingTextInterval = setInterval(() => {
                subtextElement.textContent = loadingMessages[index];
                index = (index + 1) % loadingMessages.length;
            }, 2000);
        }

        // Hàm Dừng hiệu ứng Loading Text (Chức năng 6b)
        function stopLoadingAnimation() {
            if (loadingTextInterval) {
                clearInterval(loadingTextInterval);
                // Đặt lại văn bản về trạng thái mặc định
                document.getElementById('loadingSubtext').textContent = "Vui lòng chờ trong giây lát";
            }
        }

        // Preview image
        document.getElementById('foodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    const uploadArea = document.querySelector('.upload-area');
                    // const analyzeBtn = document.getElementById('analyzeBtn');

                    // THÊM: Lấy element chứa nội dung hướng dẫn
                    const uploadPrompt = document.getElementById('uploadPrompt');

                    preview.src = e.target.result;
                    preview.className = 'preview-image-inside'; // Đảm bảo sử dụng class mới
                    preview.style.display = 'block';
                    uploadPrompt.style.display = 'none'; // ẨN NỘI DUNG HƯỚNG DẪN
                    uploadArea.classList.add('active'); // Style mặc định
                    uploadArea.classList.add('has-preview'); // Thêm class để ẩn border dashed (Tùy chọn)
                    document.getElementById('analyzeSimpleBtn').style.display = 'inline-block';
                    document.getElementById('analyzeDeepBtn').style.display = 'inline-block';
                    // analyzeBtn.style.display = 'inline-block';
                    // uploadArea.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });
                // Tự động preview khi chọn/chụp ảnh
        // function previewImage(input) {
        //     const file = input.files[0];
        //     if (file) {
        //         const reader = new FileReader();
        //         reader.onload = function(e) {
        //             const preview = document.getElementById('preview');
        //             const uploadArea = document.querySelector('.upload-area');
        //             const analyzeBtn = document.getElementById('analyzeBtn');

        //             preview.src = e.target.result;
        //             preview.style.display = 'block';
        //             analyzeBtn.style.display = 'inline-block';
        //             uploadArea.classList.add('active');
        //         };
        //         reader.readAsDataURL(file);
        //     }
        // }
        //         // Gắn sự kiện vào input
        // document.getElementById('foodImage').addEventListener('change', function() {
        //     previewImage(this);
        // });

            async function analyze(isDeepAnalysis = false) { // <-- F13: NHẬN FLAG
            const files = document.getElementById('foodImage').files;
            const mealType = document.getElementById('mealTypeSelect').value;

            if (files.length === 0) {
                alert("Vui lòng chọn ảnh!");
                return;
            }
            if (mealType === 'ChuaChon') {
                alert("Vui lòng chọn loại bữa ăn trước khi phân tích!");
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            const analyzeSimpleBtn = document.getElementById('analyzeSimpleBtn');
            const analyzeDeepBtn = document.getElementById('analyzeDeepBtn');

            // Disable cả hai nút
            analyzeSimpleBtn.disabled = true;
            analyzeDeepBtn.disabled = true;

            // Show loading
            loadingOverlay.classList.add('show');
            startLoadingAnimation();

            try {
                const form = new FormData();
                form.append('image', files[0]);
                form.append('mealType', mealType);
                form.append('deepAnalysis', isDeepAnalysis ? 'true' : 'false'); // <-- F13: GỬI FLAG

                const response = await fetch('/Home/Analyze', {
                    method: 'POST',
                    body: form
                });

                const jsonString = await response.text();
                let data;
                try {
                    data = JSON.parse(jsonString);
                } catch {
                    // Xử lý lỗi nếu JSON không hợp lệ
                    document.getElementById('result').innerHTML = `
                    <div class="result-card warning">
                        <div class="warning-text">
                            Lỗi phân tích JSON từ AI. Phản hồi thô: ${jsonString.substring(0, 200)}...
                        </div>
                    </div>
                    `;
                    return;
                }

                stopLoadingAnimation();
                loadingOverlay.classList.remove('show');
                analyzeSimpleBtn.disabled = false;
                analyzeDeepBtn.disabled = false;


                if (data.error) {
                    document.getElementById('result').innerHTML = `
                    <div class="result-card warning">
                        <div class="warning-text">
                            ${data.error}
                        </div>
                    </div>
                    `;
                    return;
                }

                // *** BỔ SUNG LOGIC XANH/ĐỎ VÀ DEEP ANALYSIS (F13) ***
                const isWarning = data.warning;
                const cardClass = isWarning ? 'warning' : 'success';
                let html = `
                <div class="result-card ${cardClass}">
                    <div class="food-name">
                        ${isWarning ? '⚠️' : '✅'} ${data.food_name}
                    </div>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-label">Calo</div>
                            <div class="nutrition-value">${data.calories}</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Protein</div>
                            <div class="nutrition-value">${data.protein}g</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Carbs</div>
                            <div class="nutrition-value">${data.carbs}g</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-label">Fat</div>
                            <div class="nutrition-value">${data.fat}g</div>
                        </div>
                    </div>
                `;

                // HIỂN THỊ THÀNH PHẦN CHI TIẾT NẾU LÀ DEEP ANALYSIS (F13)
                if (isDeepAnalysis && data.detailed_components && data.detailed_components.length > 0) {
                     let componentsHtml = '<h6 class="mt-4" style="font-weight: 700; color: #3b82f6;">🔬 Thành phần chi tiết:</h6><ul class="list-unstyled">';
                     data.detailed_components.forEach(comp => {
                         componentsHtml += `<li style="font-size: 0.95rem; border-bottom: 1px dotted #e2e8f0; padding: 5px 0;"><strong>${comp.name}</strong>: ${comp.calories} kcal, ${comp.protein}g Protein</li>`;
                     });
                     componentsHtml += '</ul>';
                     html += componentsHtml;
                }

                // HIỂN THỊ HỘP KHUYÊN
                if (isWarning) {
                html += `
                <div class="warning-box">
                    <p class="warning-text" style="color: #c53030; font-size: 1.1rem; margin-bottom: 10px;">
                        ${data.advice}
                    </p>
                    <p class="warning-text" style="font-size: 1rem; color: #718096;">
                        ${data.burn_time}
                    </p>
                </div>
                `;
                } else {
                html += `
                <div class="warning-box" style="
                background: linear-gradient(135deg, #f0fff4 0%, #d1fae5 100%);
                border: 2px solid #48bb78;
                ">
                <p class="warning-text" style="color: #065f46; font-size: 1.1rem; margin-bottom: 0;">
                ${data.advice || '✅ Món ăn này phù hợp với mục tiêu dinh dưỡng hiện tại của bạn. Ăn tốt nhé!'}
                </p>
                </div>
                `;
                }
                html += `</div>`;
                document.getElementById('result').innerHTML = html;

            } catch (error) {
                stopLoadingAnimation();
                loadingOverlay.classList.remove('show');
                analyzeSimpleBtn.disabled = false;
                analyzeDeepBtn.disabled = false;
                document.getElementById('result').innerHTML = `
                <div class="result-card warning">
                <div class="warning-text">
                Lỗi kết nối: ${error.message}
                </div>
                </div>
                `;
            }
        }
    </script>
    <script>
                // Hàm mở Modal nâng cấp
        function showUpgradeModal() {
            // Ngăn chặn hành động mặc định (không gửi request phân tích)
            const modal = document.getElementById('upgradeModal');
            modal.style.display = 'flex';
            // Timeout nhỏ để kích hoạt transition CSS
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // Hàm đóng Modal khi click ra ngoài hoặc nút đóng
        function closeUpgradeModal(event) {
            const modal = document.getElementById('upgradeModal');
            // Nếu click vào lớp phủ (overlay) hoặc nút đóng thì mới đóng
            if (event.target === modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300); // Chờ animation kết thúc
            }
        }

        // Hàm giả lập chuyển trang thanh toán
        function goToPayment() {
            alert("Chức năng đang phát triển! Sắp ra mắt cổng thanh toán.");
            // Sau này bạn thay bằng: window.location.href = '/Payment/Plans';
        }
    </script>
}