@{
    ViewData["Title"] = "Phân tích món ăn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles {
    <style>
        .analyze-section {
            min-height: 100vh;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #f0f4f8 100%);
            padding: 60px 0;
        }

        .analyze-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .page-title {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .upload-area {
            border: 3px dashed #48bb78;
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f0fdf4 0%, #f8fafc 100%);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

            .upload-area:hover {
                border-color: #38a169;
                background: linear-gradient(135deg, #e6f9f0 0%, #f1f5f9 100%);
                transform: scale(1.02);
            }

            .upload-area.active {
                border-color: #48bb78;
                background: linear-gradient(135deg, #f0fff4 0%, #f0fdf4 100%);
            }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #718096;
            font-size: 0.95rem;
        }

        .file-input {
            display: none;
        }

        .preview-image-inside {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 18px;
            display: none;
        }

        .upload-area.has-preview #uploadPrompt {
            display: none;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 15px;
            padding: 15px 50px;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
            transition: all 0.3s ease;
            margin-top: 20px;
            display: none;
        }

            .analyze-btn:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
            }

            .analyze-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        /* Loading Animation */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

            .loading-overlay.show {
                display: flex;
            }

        .loading-content {
            text-align: center;
            color: #2d3748;
        }

        .spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            position: relative;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #48bb78;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

            .spinner-ring:nth-child(2) {
                border-top-color: #4299e1;
                animation-duration: 1.5s;
            }

            .spinner-ring:nth-child(3) {
                border-top-color: #ed8936;
                animation-duration: 2s;
            }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .loading-subtext {
            font-size: 1rem;
            opacity: 0.8;
            animation: pulse 2s ease-in-out infinite;
            color: #4a5568;
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* Result Card */
        .result-card {
            background: white;
            border-radius: 25px;
            padding: 35px;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            animation: slideUp 0.5s ease;
            border-left: 6px solid #48bb78;
        }

            .result-card.success {
                border-left-color: #48bb78;
            }

                .result-card.success .food-name {
                    color: #48bb78;
                }

                .result-card.success .nutrition-item {
                    background: linear-gradient(135deg, #f0fff4 0%, #f0fdf4 100%);
                    border: 1px solid #d1fae5;
                }

                .result-card.success .nutrition-value {
                    color: #059669;
                }

            .result-card.warning {
                border-left-color: #f56565;
            }

        @@keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .food-name {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .nutrition-item {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .nutrition-label {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .nutrition-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #fc8181;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .warning-text {
            color: #c53030;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @@media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }

            .upload-card {
                padding: 25px;
            }

            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }        
        @@media (max-width: 576px) {
            .upload-area

        {
            min-height: 250px; /* Thay vì 300px */
            padding: 30px 20px;
        }

        #mealTypeSelect {
            font-size: 1.1rem;
            padding: 16px 20px;
            border: 3px solid #10b981; /* Làm nổi bật hơn */
        }

        .preview-image-inside {
            object-fit: contain; /* Thay vì cover để xem full ảnh */
        }

        }
    </style>
}
<div class="analyze-section">
    <div class="container analyze-container">
        <h1 class="page-title">📸 Phân tích món ăn của bạn</h1>

        <div class="upload-card">
            <!-- KHỐI BỔ SUNG: CHỌN LOẠI BỮA ĂN -->
            <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 20px;">1. Chọn Loại Bữa Ăn</h4>
            <select id="mealTypeSelect" class="form-select mb-4" style="
                    border: 2px solid #e2e8f0;
                    border-radius: 15px;
                    padding: 14px 20px;
                    font-size: 1rem;
                    transition: all 0.3s ease;">
                <option value="ChuaChon">--- Chọn loại bữa ăn ---</option>
                <option value="BuaSang">☀️ Bữa Sáng</option>
                <option value="BuaTrua">🍔 Bữa Trưa</option>
                <option value="BuaToi">🌙 Bữa Tối</option>
                <option value="AnVat">🍭 Ăn Vặt / Khác</option>
            </select>
            <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 20px;">2. Tải ảnh món ăn</h4>

            <div class="upload-area" id="uploadAreaContainer" onclick="document.getElementById('foodImage').click()">
                <div id="uploadPrompt">
                    <span class="upload-icon">📷</span>
                    <div class="upload-text">Nhấn để chọn ảnh hoặc chụp ảnh</div>
                    <div class="upload-hint">Hỗ trợ: JPG, PNG (tối đa 10MB)</div>
                </div>
                <!-- ẢNH PREVIEW (SẼ HIỂN THỊ TRONG KHUNG) -->
                <img id="preview" class="preview-image-inside" alt="Preview" />
            </div>

            @* <input type="file" id="foodImage" accept="image/*" capture="environment" class="file-input" /> *@
            @* <input type="file" id="foodImage" accept="image/*" capture="user" class="file-input" /> *@
            <input type="file" id="foodImage" accept="image/*" capture="camera" class="file-input" />

            @* ✅ THÊM: Tips Section *@
            <div id="analysisTips" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 4px solid #f59e0b;">
                <h5 style="color: #92400e; font-weight: 700; margin-bottom: 10px;">💡 Mẹo để AI phân tích chính xác:</h5>
                <ul style="color: #78350f; margin: 0; padding-left: 20px; font-size: 0.9rem;">
                    <li>Chụp ảnh rõ nét, đủ ánh sáng</li>
                    <li>Hiển thị toàn bộ món ăn trong khung hình</li>
                    <li>Tránh che khuất bởi tay hoặc vật dụng</li>
                    <li>Một ảnh nên chỉ có một món ăn chính</li>
                </ul>
            </div>

            <div class="text-center">
                @* <img id="preview" class="preview-image" alt="Preview" /> *@
                <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">
                    🔍 Phân tích ngay
                </button>
            </div>
        </div>

        <div id="result"></div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
        </div>
        <div class="loading-text">🤖 AI đang phân tích...</div>
        <div class="loading-subtext" id="loadingSubtext">Vui lòng chờ trong giây lát</div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('foodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    const uploadArea = document.querySelector('.upload-area');
                    const analyzeBtn = document.getElementById('analyzeBtn');
                    const uploadPrompt = document.getElementById('uploadPrompt');
                    const analysisTips = document.getElementById('analysisTips');

                    preview.src = e.target.result;
                    preview.className = 'preview-image-inside';
                    preview.style.display = 'block';
                    uploadPrompt.style.display = 'none';
                    uploadArea.classList.add('active');
                    uploadArea.classList.add('has-preview');
                    analyzeBtn.style.display = 'inline-block';

                    // ✅ HIỂN THỊ TIPS
                    analysisTips.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
    <script>
        // Khai báo biến toàn cục để kiểm soát interval (Chức năng 6b)
        let loadingTextInterval;
        const loadingMessages = [
            "AI đang nhận diện món ăn...",
            "Đang tính toán giá trị dinh dưỡng...",
            "Đang cá nhân hóa lời khuyên dựa trên mục tiêu...",
            "Gần xong rồi, chỉ vài giây nữa thôi!"
        ];

        // Hàm Khởi tạo hiệu ứng Loading Text (Chức năng 6b)
        function startLoadingAnimation() {
            const subtextElement = document.getElementById('loadingSubtext');
            let index = 0;

            // Đặt nội dung ban đầu
            subtextElement.textContent = loadingMessages[index];
            index = (index + 1) % loadingMessages.length;

            // Thiết lập interval để thay đổi nội dung mỗi 2000ms (2 giây)
            loadingTextInterval = setInterval(() => {
                subtextElement.textContent = loadingMessages[index];
                index = (index + 1) % loadingMessages.length;
            }, 2000);
        }

        // Hàm Dừng hiệu ứng Loading Text (Chức năng 6b)
        function stopLoadingAnimation() {
            if (loadingTextInterval) {
                clearInterval(loadingTextInterval);
                // Đặt lại văn bản về trạng thái mặc định
                document.getElementById('loadingSubtext').textContent = "Vui lòng chờ trong giây lát";
            }
        }

        // Preview image
        document.getElementById('foodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    const uploadArea = document.querySelector('.upload-area');
                    const analyzeBtn = document.getElementById('analyzeBtn');

                    // THÊM: Lấy element chứa nội dung hướng dẫn
                    const uploadPrompt = document.getElementById('uploadPrompt');

                    preview.src = e.target.result;
                    preview.className = 'preview-image-inside'; // Đảm bảo sử dụng class mới
                    preview.style.display = 'block';
                    uploadPrompt.style.display = 'none'; // ẨN NỘI DUNG HƯỚNG DẪN
                    uploadArea.classList.add('active'); // Style mặc định
                    uploadArea.classList.add('has-preview'); // Thêm class để ẩn border dashed (Tùy chọn)
                    analyzeBtn.style.display = 'inline-block';
                    // uploadArea.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });
                // Tự động preview khi chọn/chụp ảnh
        // function previewImage(input) {
        //     const file = input.files[0];
        //     if (file) {
        //         const reader = new FileReader();
        //         reader.onload = function(e) {
        //             const preview = document.getElementById('preview');
        //             const uploadArea = document.querySelector('.upload-area');
        //             const analyzeBtn = document.getElementById('analyzeBtn');

        //             preview.src = e.target.result;
        //             preview.style.display = 'block';
        //             analyzeBtn.style.display = 'inline-block';
        //             uploadArea.classList.add('active');
        //         };
        //         reader.readAsDataURL(file);
        //     }
        // }
        //         // Gắn sự kiện vào input
        // document.getElementById('foodImage').addEventListener('change', function() {
        //     previewImage(this);
        // });

        async function analyze() {
        const files = document.getElementById('foodImage').files[0];
        const mealType = document.getElementById('mealTypeSelect').value; // <--- LẤY MEAL TYPE

        if (!files) {
            alert("Vui lòng chọn ảnh!");
            return;
        }
        // Lấy tệp đầu tiên (file) để gửi đi
        // const fileToSend = files;
        // KIỂM TRA BẮT BUỘC CHỌN MEAL TYPE
        if (mealType === 'ChuaChon') {
            alert("Vui lòng chọn loại bữa ăn trước khi phân tích!");
            return;
        }

        const loadingOverlay = document.getElementById('loadingOverlay');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // Show loading
        loadingOverlay.classList.add('show');
        analyzeBtn.disabled = true;
        startLoadingAnimation();

        try {
            const form = new FormData();
            form.append('image', files);
            // THÊM MEAL TYPE VÀO FORM DATA
            form.append('mealType', mealType);

            // [4] Call API
            const res = await fetch('/Home/Analyze', {
                method: 'POST',
                body: form
            });
            const data = await res.json();

            // Hide loading
            loadingOverlay.classList.remove('show');
            analyzeBtn.disabled = false;
            stopLoadingAnimation();

                if (data.error) {
                    document.getElementById('result').innerHTML = `
                        <div class="result-card warning">
                            <div class="warning-text">
                                ⚠️ ${data.error}
                            </div>
                        </div>
                    `;
                    return;
                }


        // *** BỔ SUNG LOGIC XANH/ĐỎ ***
        const isWarning = data.warning;
        const cardClass = isWarning ? 'warning' : 'success'; // Màu xanh nếu không có warning

        let html = `
        <div class="result-card ${cardClass}">
        <div class="food-name">
        ${isWarning ? '⚠️ ' : '✅ '} ${data.food_name}
        </div>

        <!-- Hiển thị Grid Dinh Dưỡng ... [6, 7] -->
        <div class="nutrition-grid">
            <div class="nutrition-item">
                <div class="nutrition-label">🔥 Calo</div>
                <div class="nutrition-value">${data.calories}</div>
            </div>
            <div class="nutrition-item">
                <div class="nutrition-label">💪 Protein</div>
                <div class="nutrition-value">${data.protein}g</div>
            </div>
            <div class="nutrition-item">
                <div class="nutrition-label">🍚 Carbs</div>
                <div class="nutrition-value">${data.carbs}g</div>
            </div>
            <div class="nutrition-item">
                <div class="nutrition-label">🥑 Fat</div>
                <div class="nutrition-value">${data.fat}g</div>
            </div>
        </div>
        `;
        // KIỂM TRA CẢNH BÁO VÀ HIỂN THỊ HỘP KHUYÊN
        if (isWarning) { // HIỂN THỊ HỘP CẢNH BÁO ĐỎ [8]
            html += `
            <div class="warning-box">
                <p class="warning-text" style="color: #c53030; font-size: 1.1rem; margin-bottom: 10px;">
                    ⚠️ ${data.advice}
                </p>
                <p class="warning-text" style="font-size: 1rem; color: #718096;">
                    ⏱️ ${data.burn_time}
                </p>
            </div>
            `;
        } else { // HIỂN THỊ HỘP THÀNH CÔNG XANH
            html += `
            <div class="warning-box" style="
                background: linear-gradient(135deg, #f0fff4 0%, #d1fae5 100%);
                border: 2px solid #48bb78;
            ">
                <p class="warning-text" style="color: #065f46; font-size: 1.1rem; margin-bottom: 0;">
                    ${data.advice || '✅ Món ăn này phù hợp với mục tiêu dinh dưỡng hiện tại của bạn. Ăn tốt nhé!'}
                </p>
            </div>
            `;
        }
        html += `</div>`;
                document.getElementById('result').innerHTML = html;

                // Scroll to result
                document.getElementById('result').scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });

            } catch (error) {
                loadingOverlay.classList.remove('show');
                analyzeBtn.disabled = false;

                document.getElementById('result').innerHTML = `
                    <div class="result-card warning">
                        <div class="warning-text">
                            ❌ Lỗi kết nối: ${error.message}
                        </div>
                    </div>
                `;
            }
        }
    </script>
}