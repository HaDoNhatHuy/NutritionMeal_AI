@using NutritionWebApp.Models.Entities
@using System.Text.Json
@{
    ViewData["Title"] = "Kế Hoạch Tập Luyện";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var planData = (JsonElement)ViewBag.PlanData;
    var plan = ViewBag.Plan;
    var progress = (ViewBag.Progress as List<WorkoutProgress>) ?? new List<WorkoutProgress>();
}
@functions {
    public string SanitizeId(string name)
    {
        // 1. Loại bỏ các ký tự không phải chữ/số/khoảng trắng/dấu gạch ngang
        string safeName = System.Text.RegularExpressions.Regex.Replace(name, @"[^a-zA-Z0-9\s-]", "");
        // 2. Thay thế khoảng trắng và gạch ngang kép bằng gạch ngang đơn
        safeName = safeName.Replace(' ', '-').Replace("--", "-").Trim('-');
        return safeName;
    }
}

@section Styles {
    <style>
        .workout-viewer {
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 40px 0;
        }

        .plan-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 40px;
            border-radius: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .plan-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .plan-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .week-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f9ff;
        }

        .week-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
        }

        .week-focus {
            color: #3b82f6;
            font-weight: 600;
        }

        .day-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .day-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .exercise-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
        }

            .exercise-item:hover {
                transform: translateX(5px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

        .exercise-gif {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .exercise-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .detail-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .exercise-notes {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .warmup-cooldown {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .progress-tracker {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .nutrition-tips {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }

        .tips-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #065f46;
            margin-bottom: 20px;
        }

        .tip-item {
            padding: 12px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            margin-bottom: 10px;
        }
    </style>
}

<div class="workout-viewer">
    <div class="container">
        <!-- Header -->
        <div class="plan-header">
            <div class="plan-title">💪 @planData.GetProperty("planName").GetString()</div>
            <div class="plan-meta">
                <div class="meta-item">
                    <span>🎯</span>
                    <span>@planData.GetProperty("goal").GetString()</span>
                </div>
                <div class="meta-item">
                    <span>📊</span>
                    <span>@planData.GetProperty("level").GetString()</span>
                </div>
                <div class="meta-item">
                    <span>⏱️</span>
                    <span>@plan.Duration tuần</span>
                </div>
                <div class="meta-item">
                    <span>📅</span>
                    <span>@plan.Frequency ngày/tuần</span>
                </div>
            </div>
        </div>

        <!-- Weeks -->
        @foreach (var week in planData.GetProperty("weeks").EnumerateArray())
        {
            <div class="week-card">
                <div class="week-header">
                    <div>
                        <div class="week-title">Tuần @week.GetProperty("weekNumber").GetInt32()</div>
                        <div class="week-focus">🎯 @week.GetProperty("focus").GetString()</div>
                    </div>
                </div>

                @foreach (var day in week.GetProperty("days").EnumerateArray())
                {
                    <div class="day-card">
                        <div class="day-header">
                            📅 Ngày @day.GetProperty("dayNumber").GetInt32() - @day.GetProperty("focus").GetString()
                        </div>

                        <!-- Warm-up -->
                        <div class="warmup-cooldown">
                            <strong>🔥 Khởi động:</strong> @day.GetProperty("warmup").GetString()
                        </div>

                        <!-- Exercises -->
                        <div class="exercise-list">
                            @foreach (var exercise in day.GetProperty("exercises").EnumerateArray())
                            {
                                var exerciseName = exercise.GetProperty("name").GetString();
                                var safeIdName = SanitizeId(exerciseName); // <-- Sử dụng hàm SanitizeId mới
                                var progressItem = progress.FirstOrDefault(p =>
                                p.ExerciseName == exerciseName &&
                                p.WeekNumber == week.GetProperty("weekNumber").GetInt32() &&
                                p.DayNumber == day.GetProperty("dayNumber").GetInt32());
                                var isCompleted = progressItem?.Completed ?? false;

                                <div class="exercise-item">
                                    <div class="d-flex align-items-start mb-2">
                                        @if (exercise.TryGetProperty("gifUrl", out var gifUrl) && !string.IsNullOrEmpty(gifUrl.GetString()))
                                        {
                                            <img src="@gifUrl.GetString()"
                                                 alt="@exerciseName"
                                                 class="exercise-gif me-3"
                                                 style="max-width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                                        }

                                        <div style="flex-grow: 1;">
                                            <h5 class="exercise-name" style="font-weight: 700;">@exerciseName</h5>
                                            <div class="exercise-details d-flex gap-3">
                                                <span class="badge bg-primary">Sets: @exercise.GetProperty("sets").GetInt32()</span>
                                                <span class="badge bg-info">Reps: @exercise.GetProperty("reps").GetString()</span>
                                                @if (exercise.TryGetProperty("rest", out var rest))
                                                {
                                                    <span class="badge bg-secondary">Rest: @rest.GetString()</span>
                                                }
                                                @if (exercise.TryGetProperty("tempo", out var tempo))
                                                {
                                                    <span class="badge bg-warning text-dark">Tempo: @tempo.GetString()</span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <div class="exercise-notes">
                                        <strong>Ghi chú HLV:</strong> @exercise.GetProperty("notes").GetString()
                                    </div>
                                    @if (exercise.TryGetProperty("instructions", out var instructionsArray) && instructionsArray.ValueKind == JsonValueKind.Array)
                                    {
                                        <div class="exercise-instructions mt-2 p-3 bg-light rounded" style="border-left: 3px solid #f59e0b;">
                                            <strong>Hướng dẫn chi tiết:</strong>
                                            <ol style="font-size: 0.9rem; margin-top: 5px;">
                                                @foreach (var instruction in instructionsArray.EnumerateArray().Select(i => i.GetString()))
                                                {
                                                    <li>@instruction</li>
                                                }
                                            </ol>
                                        </div>
                                    }

                                    <!-- Progress Tracker CHI TIẾT (F15) -->
                                    <div class="progress-tracker card p-3 mt-3">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-12 mb-2">
                                                <label class="checkbox-label d-flex align-items-center">
                                                    <input type="checkbox"
                                                           class="exercise-checkbox form-check-input me-2"
                                                           id="check-@safeIdName"
                                                           data-plan="@plan.PlanId"
                                                           data-week="@week.GetProperty("weekNumber").GetInt32()"
                                                           data-day="@day.GetProperty("dayNumber").GetInt32()"
                                                           data-exercise="@exerciseName"
                                                           data-safe-id="@safeIdName"
                                                    @(isCompleted ? "checked" : "")>
                                                    <span style="font-weight: 700;">✅ Bài tập này đã hoàn thành</span>
                                                </label>
                                            </div>
                                            @if (progressItem != null)
                                            {
                                                <p class="text-success small">Đã log: Sets @progressItem.SetsCompleted / Tạ @progressItem.WeightUsed / Cảm nhận: @progressItem.Rating sao (@progressItem.Notes)</p>
                                            }

                                            <div class="col-md-3">
                                                <input type="text" placeholder="Sets/Reps thực tế" class="form-control form-control-sm progress-input"
                                                       data-field="setsReps" id="setsReps-@safeIdName"
                                                       data-safe-id="@safeIdName"   
                                                       value="@(progressItem?.SetsCompleted > 0 ? progressItem.SetsCompleted.ToString() : "")">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="number" step="0.5" placeholder="Tạ dùng (kg)" class="form-control form-control-sm progress-input"
                                                       data-field="weight" id="weight-@(exerciseName.Replace(" ", "-"))"
                                                       value="@(progressItem?.WeightUsed)">
                                            </div>
                                            <div class="col-md-4">
                                                <input type="text" placeholder="Ghi chú (cảm nhận, lỗi form)" class="form-control form-control-sm progress-input"
                                                       data-field="notes" id="notes-@(exerciseName.Replace(" ", "-"))"
                                                       value="@progressItem?.Notes">
                                            </div>
                                            <div class="col-md-2">
                                                <select class="form-select form-control-sm progress-input" data-field="rating"
                                                        id="rating-@(exerciseName.Replace(" ", "-"))">
                                                    <option value="">Rating</option>
                                                    <option value="5" selected="@(progressItem?.Rating == 5)">5 ⭐ Xuất sắc</option>
                                                    <option value="4" selected="@(progressItem?.Rating == 4)">4 ⭐ Tốt</option>
                                                    <option value="3" selected="@(progressItem?.Rating == 3)">3 ⭐ Bình thường</option>
                                                    <option value="2" selected="@(progressItem?.Rating == 2)">2 ⭐ Khó khăn</option>
                                                    <option value="1" selected="@(progressItem?.Rating == 1)">1 ⭐ Rất tệ</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Cool-down -->
                        <div class="warmup-cooldown">
                            <strong>❄️ Hồi phục:</strong> @day.GetProperty("cooldown").GetString()
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Nutrition Tips -->
        @if (planData.TryGetProperty("nutritionTips", out var tips))
        {
            <div class="nutrition-tips">
                <div class="tips-title">🥗 Lời khuyên Dinh dưỡng</div>
                @foreach (var tip in tips.EnumerateArray())
                {
                    <div class="tip-item">💡 @tip.GetString()</div>
                }
            </div>
        }

        <!-- Actions -->
        <div class="text-center" style="margin-top: 30px;">
            <a asp-action="Index" class="btn btn-modern btn-login" style="padding: 0.75rem 2rem;">
                ← Quay lại Danh sách
            </a>
        </div>
    </div>
</div>

<!-- Thêm modal vào cuối trang -->
<div class="modal fade" id="exerciseModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exerciseModalLabel">Chi tiết bài tập</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="exerciseGifLarge" src="" alt="" style="max-width: 100%; border-radius: 12px;">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.exercise-gif').forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function() {
                document.getElementById('exerciseGifLarge').src = this.src;
                document.getElementById('exerciseModalLabel').textContent = this.alt;
                new bootstrap.Modal(document.getElementById('exerciseModal')).show();
            });
        });
    </script>

    <script>
        document.querySelectorAll('.exercise-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async function() {
                const completed = this.checked;
                const exerciseName = this.dataset.exercise;
                const parent = this.closest('.exercise-item');
                // FIX BUG 5.1/5.2: Lấy ID đã được sanitize từ data attribute
                const safeId = this.dataset.safeId;

                // Thu thập dữ liệu chi tiết từ các input mới (F15)
                const setsRepsInput = parent.querySelector(`#setsReps-${safeId}`);
                const weightInput = parent.querySelector(`#weight-${safeId}`);
                const ratingInput = parent.querySelector(`#rating-${safeId}`);
                const notesInput = parent.querySelector(`#notes-${safeId}`);

                const payload = {
                    PlanId: parseInt(this.dataset.plan),
                    WeekNumber: parseInt(this.dataset.week),
                    DayNumber: parseInt(this.dataset.day),
                    ExerciseName: exerciseName,
                    Completed: completed,
                    // Dữ liệu mới (F15)
                    SetsCompleted: parseInt(setsRepsInput.value) || 0,
                    RepsCompleted: setsRepsInput.value || null, // Lưu dưới dạng chuỗi Sets/Reps
                    WeightUsed: weightInput.value || null,
                    Notes: notesInput.value || null,
                    Rating: parseInt(ratingInput.value) || null
                };

                // Validate cơ bản nếu đánh dấu hoàn thành
                if (completed && payload.SetsCompleted === 0) {
                     // Nếu hoàn thành mà không nhập set/rep, hỏi người dùng
                     if (!confirm('Bạn đánh dấu hoàn thành nhưng chưa nhập Sets/Reps. Bạn vẫn muốn lưu?')) {
                         this.checked = false; // Bỏ check nếu người dùng hủy
                         return;
                     }
                }

                try {
                    const response = await fetch('/Workout/UpdateProgress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (data.success) {
                        console.log('Progress updated successfully.');
                        // Không cần reload, nhưng có thể cập nhật hiển thị nếu cần
                    } else {
                        alert('Lỗi: ' + data.error);
                        this.checked = !completed; // Quay lại trạng thái cũ
                    }
                } catch (error) {
                    alert('Lỗi kết nối: ' + error.message);
                    this.checked = !completed;
                }
            });
        });
    </script>
}